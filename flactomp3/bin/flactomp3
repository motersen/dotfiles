#!/usr/bin/perl

use warnings;
use strict;

use File::Basename;
use File::Path qw(make_path);

open my $stream, '| parallel ffmpeg -loglevel error -i {} -qscale:a 0 "mp3/{.}.mp3"';
while (my $input = <STDIN>) {
    unless ($input =~ m|\.flac$|) {
	print "$input not flac\n";
	continue;
    }
    make_output_path(dirname($input));
    print $stream $input;
}
close $stream;

sub make_output_path {
    make_path "mp3/${\shift}";
}
